<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='global-property-'>/**
</span> * @license Copyright (c) 2003-2016, CKSource - Frederico Knabben. All rights reserved.
 * For licensing, see LICENSE.md or http://ckeditor.com/license
 */

( function() {
	var imageDialog = function( editor, dialogType ) {
			// Load image preview.
			var IMAGE = 1,
				LINK = 2,
				PREVIEW = 4,
				CLEANUP = 8,
				regexGetSize = /^\s*(\d+)((px)|\%)?\s*$/i,
				regexGetSizeOrEmpty = /(^\s*(\d+)((px)|\%)?\s*$)|^$/i,
				pxLengthRegex = /^\d+px$/;

			var onSizeChange = function() {
					var value = this.getValue(),
						// This = input element.
						dialog = this.getDialog(),
						aMatch = value.match( regexGetSize ); // Check value
					if ( aMatch ) {
						if ( aMatch[ 2 ] == &#39;%&#39; ) // % is allowed - &gt; unlock ratio.
						switchLockRatio( dialog, false ); // Unlock.
						value = aMatch[ 1 ];
					}

					// Only if ratio is locked
					if ( dialog.lockRatio ) {
						var oImageOriginal = dialog.originalElement;
						if ( oImageOriginal.getCustomData( &#39;isReady&#39; ) == &#39;true&#39; ) {
							if ( this.id == &#39;txtHeight&#39; ) {
								if ( value &amp;&amp; value != &#39;0&#39; )
									value = Math.round( oImageOriginal.$.width * ( value / oImageOriginal.$.height ) );
								if ( !isNaN( value ) )
									dialog.setValueOf( &#39;info&#39;, &#39;txtWidth&#39;, value );
							}
							// this.id = txtWidth.
							else {
								if ( value &amp;&amp; value != &#39;0&#39; )
									value = Math.round( oImageOriginal.$.height * ( value / oImageOriginal.$.width ) );
								if ( !isNaN( value ) )
									dialog.setValueOf( &#39;info&#39;, &#39;txtHeight&#39;, value );
							}
						}
					}
					updatePreview( dialog );
				};

			var updatePreview = function( dialog ) {
					//Don&#39;t load before onShow.
					if ( !dialog.originalElement || !dialog.preview )
						return 1;

					// Read attributes and update imagePreview;
					dialog.commitContent( PREVIEW, dialog.preview );
					return 0;
				};

			// Custom commit dialog logic, where we&#39;re intended to give inline style
			// field (txtdlgGenStyle) higher priority to avoid overwriting styles contribute
			// by other fields.
			function commitContent() {
				var args = arguments;
				var inlineStyleField = this.getContentElement( &#39;advanced&#39;, &#39;txtdlgGenStyle&#39; );
				inlineStyleField &amp;&amp; inlineStyleField.commit.apply( inlineStyleField, args );

				this.foreach( function( widget ) {
					if ( widget.commit &amp;&amp; widget.id != &#39;txtdlgGenStyle&#39; )
						widget.commit.apply( widget, args );
				} );
			}

			// Avoid recursions.
			var incommit;

			// Synchronous field values to other impacted fields is required, e.g. border
			// size change should alter inline-style text as well.
			function commitInternally( targetFields ) {
				if ( incommit )
					return;

				incommit = 1;

				var dialog = this.getDialog(),
					element = dialog.imageElement;
				if ( element ) {
					// Commit this field and broadcast to target fields.
					this.commit( IMAGE, element );

					targetFields = [].concat( targetFields );
					var length = targetFields.length,
						field;
					for ( var i = 0; i &lt; length; i++ ) {
						field = dialog.getContentElement.apply( dialog, targetFields[ i ].split( &#39;:&#39; ) );
						// May cause recursion.
						field &amp;&amp; field.setup( IMAGE, element );
					}
				}

				incommit = 0;
			}

			var switchLockRatio = function( dialog, value ) {
					if ( !dialog.getContentElement( &#39;info&#39;, &#39;ratioLock&#39; ) )
						return null;

					var oImageOriginal = dialog.originalElement;

					// Dialog may already closed. (#5505)
					if ( !oImageOriginal )
						return null;

					// Check image ratio and original image ratio, but respecting user&#39;s preference.
					if ( value == &#39;check&#39; ) {
						if ( !dialog.userlockRatio &amp;&amp; oImageOriginal.getCustomData( &#39;isReady&#39; ) == &#39;true&#39; ) {
							var width = dialog.getValueOf( &#39;info&#39;, &#39;txtWidth&#39; ),
								height = dialog.getValueOf( &#39;info&#39;, &#39;txtHeight&#39; ),
								originalRatio = oImageOriginal.$.width * 1000 / oImageOriginal.$.height,
								thisRatio = width * 1000 / height;
							dialog.lockRatio = false; // Default: unlock ratio

							if ( !width &amp;&amp; !height )
								dialog.lockRatio = true;
							else if ( !isNaN( originalRatio ) &amp;&amp; !isNaN( thisRatio ) ) {
								if ( Math.round( originalRatio ) == Math.round( thisRatio ) )
									dialog.lockRatio = true;
							}
						}
					} else if ( value !== undefined )
						dialog.lockRatio = value;
					else {
						dialog.userlockRatio = 1;
						dialog.lockRatio = !dialog.lockRatio;
					}

					var ratioButton = CKEDITOR.document.getById( btnLockSizesId );
					if ( dialog.lockRatio )
						ratioButton.removeClass( &#39;cke_btn_unlocked&#39; );
					else
						ratioButton.addClass( &#39;cke_btn_unlocked&#39; );

					ratioButton.setAttribute( &#39;aria-checked&#39;, dialog.lockRatio );

					// Ratio button hc presentation - WHITE SQUARE / BLACK SQUARE
					if ( CKEDITOR.env.hc ) {
						var icon = ratioButton.getChild( 0 );
						icon.setHtml( dialog.lockRatio ? CKEDITOR.env.ie ? &#39;\u25A0&#39; : &#39;\u25A3&#39; : CKEDITOR.env.ie ? &#39;\u25A1&#39; : &#39;\u25A2&#39; );
					}

					return dialog.lockRatio;
				};

			var resetSize = function( dialog, emptyValues ) {
					var oImageOriginal = dialog.originalElement,
						ready = oImageOriginal.getCustomData( &#39;isReady&#39; ) == &#39;true&#39;;

					if ( ready ) {
						var widthField = dialog.getContentElement( &#39;info&#39;, &#39;txtWidth&#39; ),
							heightField = dialog.getContentElement( &#39;info&#39;, &#39;txtHeight&#39; ),
							widthValue, heightValue;

						if ( emptyValues ) {
							widthValue = 0;
							heightValue = 0;
						} else {
							widthValue = oImageOriginal.$.width;
							heightValue = oImageOriginal.$.height;
						}

						widthField &amp;&amp; widthField.setValue( widthValue );
						heightField &amp;&amp; heightField.setValue( heightValue );
					}
					updatePreview( dialog );
				};

			var setupDimension = function( type, element ) {
					if ( type != IMAGE )
						return;

					function checkDimension( size, defaultValue ) {
						var aMatch = size.match( regexGetSize );
						if ( aMatch ) {
							// % is allowed.
							if ( aMatch[ 2 ] == &#39;%&#39; ) {
								aMatch[ 1 ] += &#39;%&#39;;
								switchLockRatio( dialog, false ); // Unlock ratio
							}
							return aMatch[ 1 ];
						}
						return defaultValue;
					}

					var dialog = this.getDialog(),
						value = &#39;&#39;,
						dimension = this.id == &#39;txtWidth&#39; ? &#39;width&#39; : &#39;height&#39;,
						size = element.getAttribute( dimension );

					if ( size )
						value = checkDimension( size, value );
					value = checkDimension( element.getStyle( dimension ), value );

					this.setValue( value );
				};

			var previewPreloader;

			var onImgLoadEvent = function() {
					// Image is ready.
					var original = this.originalElement,
						loader = CKEDITOR.document.getById( imagePreviewLoaderId );

					original.setCustomData( &#39;isReady&#39;, &#39;true&#39; );
					original.removeListener( &#39;load&#39;, onImgLoadEvent );
					original.removeListener( &#39;error&#39;, onImgLoadErrorEvent );
					original.removeListener( &#39;abort&#39;, onImgLoadErrorEvent );

					// Hide loader.
					if ( loader )
						loader.setStyle( &#39;display&#39;, &#39;none&#39; );

					// New image -&gt; new dimensions
					if ( !this.dontResetSize ) {
						resetSize( this, editor.config.image_prefillDimensions === false );
					}

					if ( this.firstLoad ) {
						CKEDITOR.tools.setTimeout( function() {
							switchLockRatio( this, &#39;check&#39; );
						}, 0, this );
					}

					this.firstLoad = false;
					this.dontResetSize = false;

					// Possible fix for #12818.
					updatePreview( this );
				};

			var onImgLoadErrorEvent = function() {
					// Error. Image is not loaded.
					var original = this.originalElement,
						loader = CKEDITOR.document.getById( imagePreviewLoaderId );

					original.removeListener( &#39;load&#39;, onImgLoadEvent );
					original.removeListener( &#39;error&#39;, onImgLoadErrorEvent );
					original.removeListener( &#39;abort&#39;, onImgLoadErrorEvent );

					// Set Error image.
					var noimage = CKEDITOR.getUrl( CKEDITOR.plugins.get( &#39;image&#39; ).path + &#39;images/noimage.png&#39; );

					if ( this.preview )
						this.preview.setAttribute( &#39;src&#39;, noimage );

					// Hide loader.
					if ( loader )
						loader.setStyle( &#39;display&#39;, &#39;none&#39; );

					switchLockRatio( this, false ); // Unlock.
				};

			var numbering = function( id ) {
					return CKEDITOR.tools.getNextId() + &#39;_&#39; + id;
				},
				btnLockSizesId = numbering( &#39;btnLockSizes&#39; ),
				btnResetSizeId = numbering( &#39;btnResetSize&#39; ),
				imagePreviewLoaderId = numbering( &#39;ImagePreviewLoader&#39; ),
				previewLinkId = numbering( &#39;previewLink&#39; ),
				previewImageId = numbering( &#39;previewImage&#39; );

			return {
				title: editor.lang.image[ dialogType == &#39;image&#39; ? &#39;title&#39; : &#39;titleButton&#39; ],
				minWidth: 420,
				minHeight: 360,
				onShow: function() {
					this.imageElement = false;
					this.linkElement = false;

					// Default: create a new element.
					this.imageEditMode = false;
					this.linkEditMode = false;

					this.lockRatio = true;
					this.userlockRatio = 0;
					this.dontResetSize = false;
					this.firstLoad = true;
					this.addLink = false;

					var editor = this.getParentEditor(),
						sel = editor.getSelection(),
						element = sel &amp;&amp; sel.getSelectedElement(),
						link = element &amp;&amp; editor.elementPath( element ).contains( &#39;a&#39;, 1 ),
						loader = CKEDITOR.document.getById( imagePreviewLoaderId );

					// Hide loader.
					if ( loader )
						loader.setStyle( &#39;display&#39;, &#39;none&#39; );

					// Create the preview before setup the dialog contents.
					previewPreloader = new CKEDITOR.dom.element( &#39;img&#39;, editor.document );
					this.preview = CKEDITOR.document.getById( previewImageId );

					// Copy of the image
					this.originalElement = editor.document.createElement( &#39;img&#39; );
					this.originalElement.setAttribute( &#39;alt&#39;, &#39;&#39; );
					this.originalElement.setCustomData( &#39;isReady&#39;, &#39;false&#39; );

					if ( link ) {
						this.linkElement = link;
						this.linkEditMode = true;

						// If there is an existing link, by default keep it (true).
						// It will be removed if certain conditions are met and Link tab is enabled. (#13351)
						this.addLink = true;

						// Look for Image element.
						var linkChildren = link.getChildren();
						if ( linkChildren.count() == 1 ) {
							var childTag = linkChildren.getItem( 0 );

							if ( childTag.type == CKEDITOR.NODE_ELEMENT ) {
								if ( childTag.is( &#39;img&#39; ) || childTag.is( &#39;input&#39; ) ) {
									this.imageElement = linkChildren.getItem( 0 );
									if ( this.imageElement.is( &#39;img&#39; ) )
										this.imageEditMode = &#39;img&#39;;
									else if ( this.imageElement.is( &#39;input&#39; ) )
										this.imageEditMode = &#39;input&#39;;
								}
							}
						}
						// Fill out all fields.
						if ( dialogType == &#39;image&#39; )
							this.setupContent( LINK, link );
					}

					// Edit given image element instead the one from selection.
					if ( this.customImageElement ) {
						this.imageEditMode = &#39;img&#39;;
						this.imageElement = this.customImageElement;
						delete this.customImageElement;
					}
					else if ( element &amp;&amp; element.getName() == &#39;img&#39; &amp;&amp; !element.data( &#39;cke-realelement&#39; ) ||
						element &amp;&amp; element.getName() == &#39;input&#39; &amp;&amp; element.getAttribute( &#39;type&#39; ) == &#39;image&#39; ) {
						this.imageEditMode = element.getName();
						this.imageElement = element;
					}

					if ( this.imageEditMode ) {
						// Use the original element as a buffer from  since we don&#39;t want
						// temporary changes to be committed, e.g. if the dialog is canceled.
						this.cleanImageElement = this.imageElement;
						this.imageElement = this.cleanImageElement.clone( true, true );

						// Fill out all fields.
						this.setupContent( IMAGE, this.imageElement );
					}

					// Refresh LockRatio button
					switchLockRatio( this, true );

					// Dont show preview if no URL given.
					if ( !CKEDITOR.tools.trim( this.getValueOf( &#39;info&#39;, &#39;txtUrl&#39; ) ) ) {
						this.preview.removeAttribute( &#39;src&#39; );
						this.preview.setStyle( &#39;display&#39;, &#39;none&#39; );
					}
				},
				onOk: function() {
					// Edit existing Image.
					if ( this.imageEditMode ) {
						var imgTagName = this.imageEditMode;

						// Image dialog and Input element.
						if ( dialogType == &#39;image&#39; &amp;&amp; imgTagName == &#39;input&#39; &amp;&amp; confirm( editor.lang.image.button2Img ) ) { // jshint ignore:line
							// Replace INPUT-&gt; IMG
							imgTagName = &#39;img&#39;;
							this.imageElement = editor.document.createElement( &#39;img&#39; );
							this.imageElement.setAttribute( &#39;alt&#39;, &#39;&#39; );
							editor.insertElement( this.imageElement );
						}
						// ImageButton dialog and Image element.
						else if ( dialogType != &#39;image&#39; &amp;&amp; imgTagName == &#39;img&#39; &amp;&amp; confirm( editor.lang.image.img2Button ) ) { // jshint ignore:line
							// Replace IMG -&gt; INPUT
							imgTagName = &#39;input&#39;;
							this.imageElement = editor.document.createElement( &#39;input&#39; );
							this.imageElement.setAttributes( {
								type: &#39;image&#39;,
								alt: &#39;&#39;
							} );
							editor.insertElement( this.imageElement );
						} else {
							// Restore the original element before all commits.
							this.imageElement = this.cleanImageElement;
							delete this.cleanImageElement;
						}
					}
					// Create a new image.
					else {
						// Image dialog -&gt; create IMG element.
						if ( dialogType == &#39;image&#39; )
							this.imageElement = editor.document.createElement( &#39;img&#39; );
						else {
							this.imageElement = editor.document.createElement( &#39;input&#39; );
							this.imageElement.setAttribute( &#39;type&#39;, &#39;image&#39; );
						}
						this.imageElement.setAttribute( &#39;alt&#39;, &#39;&#39; );
					}

					// Create a new link.
					if ( !this.linkEditMode )
						this.linkElement = editor.document.createElement( &#39;a&#39; );

					// Set attributes.
					this.commitContent( IMAGE, this.imageElement );
					this.commitContent( LINK, this.linkElement );

					// Remove empty style attribute.
					if ( !this.imageElement.getAttribute( &#39;style&#39; ) )
						this.imageElement.removeAttribute( &#39;style&#39; );

					// Insert a new Image.
					if ( !this.imageEditMode ) {
						if ( this.addLink ) {
							if ( !this.linkEditMode ) {
								// Insert a new link.
								editor.insertElement( this.linkElement );
								this.linkElement.append( this.imageElement, false );
							} else {
								// We already have a link in editor.
								if ( this.linkElement.equals( editor.getSelection().getSelectedElement() ) ) {
									// If the link is selected outside, replace it&#39;s content rather than the link itself. ([&lt;a&gt;foo&lt;/a&gt;])
									this.linkElement.setHtml( &#39;&#39; );
									this.linkElement.append( this.imageElement, false );
								} else {
									// Only inside of the link is selected, so replace it with image. (&lt;a&gt;[foo]&lt;/a&gt;, &lt;a&gt;[f]oo&lt;/a&gt;)
									editor.insertElement( this.imageElement );
								}
							}
						} else {
							editor.insertElement( this.imageElement );
						}
					}
					// Image already exists.
					else {
						// Add a new link element.
						if ( !this.linkEditMode &amp;&amp; this.addLink ) {
							editor.insertElement( this.linkElement );
							this.imageElement.appendTo( this.linkElement );
						}
						// Remove Link, Image exists.
						else if ( this.linkEditMode &amp;&amp; !this.addLink ) {
							editor.getSelection().selectElement( this.linkElement );
							editor.insertElement( this.imageElement );
						}
					}
				},
				onLoad: function() {
					if ( dialogType != &#39;image&#39; )
						this.hidePage( &#39;Link&#39; ); //Hide Link tab.
					var doc = this._.element.getDocument();

					if ( this.getContentElement( &#39;info&#39;, &#39;ratioLock&#39; ) ) {
						this.addFocusable( doc.getById( btnResetSizeId ), 5 );
						this.addFocusable( doc.getById( btnLockSizesId ), 5 );
					}

					this.commitContent = commitContent;
				},
				onHide: function() {
					if ( this.preview )
						this.commitContent( CLEANUP, this.preview );

					if ( this.originalElement ) {
						this.originalElement.removeListener( &#39;load&#39;, onImgLoadEvent );
						this.originalElement.removeListener( &#39;error&#39;, onImgLoadErrorEvent );
						this.originalElement.removeListener( &#39;abort&#39;, onImgLoadErrorEvent );
						this.originalElement.remove();
						this.originalElement = false; // Dialog is closed.
					}

					delete this.imageElement;
				},
				contents: [ {
					id: &#39;info&#39;,
					label: editor.lang.image.infoTab,
					accessKey: &#39;I&#39;,
					elements: [ {
						type: &#39;vbox&#39;,
						padding: 0,
						children: [ {
							type: &#39;hbox&#39;,
							widths: [ &#39;280px&#39;, &#39;110px&#39; ],
							align: &#39;right&#39;,
							children: [ {
								id: &#39;txtUrl&#39;,
								type: &#39;text&#39;,
								label: editor.lang.common.url,
								required: true,
								onChange: function() {
									var dialog = this.getDialog(),
										newUrl = this.getValue();

									// Update original image.
									// Prevent from load before onShow.
									if ( newUrl.length &gt; 0 ) {
										dialog = this.getDialog();
										var original = dialog.originalElement;

										if ( dialog.preview ) {
											dialog.preview.removeStyle( &#39;display&#39; );
										}

										original.setCustomData( &#39;isReady&#39;, &#39;false&#39; );
										// Show loader.
										var loader = CKEDITOR.document.getById( imagePreviewLoaderId );
										if ( loader )
											loader.setStyle( &#39;display&#39;, &#39;&#39; );

										original.on( &#39;load&#39;, onImgLoadEvent, dialog );
										original.on( &#39;error&#39;, onImgLoadErrorEvent, dialog );
										original.on( &#39;abort&#39;, onImgLoadErrorEvent, dialog );
										original.setAttribute( &#39;src&#39;, newUrl );

										if ( dialog.preview ) {
											// Query the preloader to figure out the url impacted by based href.
											previewPreloader.setAttribute( &#39;src&#39;, newUrl );
											dialog.preview.setAttribute( &#39;src&#39;, previewPreloader.$.src );
											updatePreview( dialog );
										}
									}
									// Dont show preview if no URL given.
									else if ( dialog.preview ) {
										dialog.preview.removeAttribute( &#39;src&#39; );
										dialog.preview.setStyle( &#39;display&#39;, &#39;none&#39; );
									}
								},
								setup: function( type, element ) {
									if ( type == IMAGE ) {
										var url = element.data( &#39;cke-saved-src&#39; ) || element.getAttribute( &#39;src&#39; );
										var field = this;

										this.getDialog().dontResetSize = true;

										field.setValue( url ); // And call this.onChange()
										// Manually set the initial value.(#4191)
										field.setInitValue();
									}
								},
								commit: function( type, element ) {
									if ( type == IMAGE &amp;&amp; ( this.getValue() || this.isChanged() ) ) {
										element.data( &#39;cke-saved-src&#39;, this.getValue() );
										element.setAttribute( &#39;src&#39;, this.getValue() );
									} else if ( type == CLEANUP ) {
										element.setAttribute( &#39;src&#39;, &#39;&#39; ); // If removeAttribute doesn&#39;t work.
										element.removeAttribute( &#39;src&#39; );
									}
								},
								validate: CKEDITOR.dialog.validate.notEmpty( editor.lang.image.urlMissing )
							},
							{
								type: &#39;button&#39;,
								id: &#39;browse&#39;,
								// v-align with the &#39;txtUrl&#39; field.
								// TODO: We need something better than a fixed size here.
								style: &#39;display:inline-block;margin-top:14px;&#39;,
								align: &#39;center&#39;,
								label: editor.lang.common.browseServer,
								hidden: true,
								filebrowser: &#39;info:txtUrl&#39;
							} ]
						} ]
					},
					{
						id: &#39;txtAlt&#39;,
						type: &#39;text&#39;,
						label: editor.lang.image.alt,
						accessKey: &#39;T&#39;,
						&#39;default&#39;: &#39;&#39;,
						onChange: function() {
							updatePreview( this.getDialog() );
						},
						setup: function( type, element ) {
							if ( type == IMAGE )
								this.setValue( element.getAttribute( &#39;alt&#39; ) );
						},
						commit: function( type, element ) {
							if ( type == IMAGE ) {
								if ( this.getValue() || this.isChanged() )
									element.setAttribute( &#39;alt&#39;, this.getValue() );
							} else if ( type == PREVIEW )
								element.setAttribute( &#39;alt&#39;, this.getValue() );
							else if ( type == CLEANUP ) {
								element.removeAttribute( &#39;alt&#39; );
							}

						}
					},
					{
						type: &#39;hbox&#39;,
						children: [ {
							id: &#39;basic&#39;,
							type: &#39;vbox&#39;,
							children: [ {
								type: &#39;hbox&#39;,
								requiredContent: &#39;img{width,height}&#39;,
								widths: [ &#39;50%&#39;, &#39;50%&#39; ],
								children: [ {
									type: &#39;vbox&#39;,
									padding: 1,
									children: [ {
										type: &#39;text&#39;,
										width: &#39;45px&#39;,
										id: &#39;txtWidth&#39;,
										label: editor.lang.common.width,
										onKeyUp: onSizeChange,
										onChange: function() {
											commitInternally.call( this, &#39;advanced:txtdlgGenStyle&#39; );
										},
										validate: function() {
											var aMatch = this.getValue().match( regexGetSizeOrEmpty ),
												isValid = !!( aMatch &amp;&amp; parseInt( aMatch[ 1 ], 10 ) !== 0 );
											if ( !isValid )
												alert( editor.lang.common.invalidWidth ); // jshint ignore:line
											return isValid;
										},
										setup: setupDimension,
										commit: function( type, element ) {
											var value = this.getValue();
											if ( type == IMAGE ) {
												if ( value &amp;&amp; editor.activeFilter.check( &#39;img{width,height}&#39; ) )
													element.setStyle( &#39;width&#39;, CKEDITOR.tools.cssLength( value ) );
												else
													element.removeStyle( &#39;width&#39; );

												element.removeAttribute( &#39;width&#39; );
											} else if ( type == PREVIEW ) {
												var aMatch = value.match( regexGetSize );
												if ( !aMatch ) {
													var oImageOriginal = this.getDialog().originalElement;
													if ( oImageOriginal.getCustomData( &#39;isReady&#39; ) == &#39;true&#39; )
														element.setStyle( &#39;width&#39;, oImageOriginal.$.width + &#39;px&#39; );
												} else {
													element.setStyle( &#39;width&#39;, CKEDITOR.tools.cssLength( value ) );
												}
											} else if ( type == CLEANUP ) {
												element.removeAttribute( &#39;width&#39; );
												element.removeStyle( &#39;width&#39; );
											}
										}
									},
									{
										type: &#39;text&#39;,
										id: &#39;txtHeight&#39;,
										width: &#39;45px&#39;,
										label: editor.lang.common.height,
										onKeyUp: onSizeChange,
										onChange: function() {
											commitInternally.call( this, &#39;advanced:txtdlgGenStyle&#39; );
										},
										validate: function() {
											var aMatch = this.getValue().match( regexGetSizeOrEmpty ),
												isValid = !!( aMatch &amp;&amp; parseInt( aMatch[ 1 ], 10 ) !== 0 );
											if ( !isValid )
												alert( editor.lang.common.invalidHeight ); // jshint ignore:line
											return isValid;
										},
										setup: setupDimension,
										commit: function( type, element ) {
											var value = this.getValue();
											if ( type == IMAGE ) {
												if ( value &amp;&amp; editor.activeFilter.check( &#39;img{width,height}&#39; ) )
													element.setStyle( &#39;height&#39;, CKEDITOR.tools.cssLength( value ) );
												else
													element.removeStyle( &#39;height&#39; );

												element.removeAttribute( &#39;height&#39; );
											} else if ( type == PREVIEW ) {
												var aMatch = value.match( regexGetSize );
												if ( !aMatch ) {
													var oImageOriginal = this.getDialog().originalElement;
													if ( oImageOriginal.getCustomData( &#39;isReady&#39; ) == &#39;true&#39; )
														element.setStyle( &#39;height&#39;, oImageOriginal.$.height + &#39;px&#39; );
												} else {
													element.setStyle( &#39;height&#39;, CKEDITOR.tools.cssLength( value ) );
												}
											} else if ( type == CLEANUP ) {
												element.removeAttribute( &#39;height&#39; );
												element.removeStyle( &#39;height&#39; );
											}
										}
									} ]
								},
								{
									id: &#39;ratioLock&#39;,
									type: &#39;html&#39;,
									style: &#39;margin-top:30px;width:40px;height:40px;&#39;,
									onLoad: function() {
										// Activate Reset button
										var resetButton = CKEDITOR.document.getById( btnResetSizeId ),
											ratioButton = CKEDITOR.document.getById( btnLockSizesId );
										if ( resetButton ) {
											resetButton.on( &#39;click&#39;, function( evt ) {
												resetSize( this );
												evt.data &amp;&amp; evt.data.preventDefault();
											}, this.getDialog() );
											resetButton.on( &#39;mouseover&#39;, function() {
												this.addClass( &#39;cke_btn_over&#39; );
											}, resetButton );
											resetButton.on( &#39;mouseout&#39;, function() {
												this.removeClass( &#39;cke_btn_over&#39; );
											}, resetButton );
										}
										// Activate (Un)LockRatio button
										if ( ratioButton ) {
											ratioButton.on( &#39;click&#39;, function( evt ) {
												switchLockRatio( this );

												var oImageOriginal = this.originalElement,
													width = this.getValueOf( &#39;info&#39;, &#39;txtWidth&#39; );

												if ( oImageOriginal.getCustomData( &#39;isReady&#39; ) == &#39;true&#39; &amp;&amp; width ) {
													var height = oImageOriginal.$.height / oImageOriginal.$.width * width;
													if ( !isNaN( height ) ) {
														this.setValueOf( &#39;info&#39;, &#39;txtHeight&#39;, Math.round( height ) );
														updatePreview( this );
													}
												}
												evt.data &amp;&amp; evt.data.preventDefault();
											}, this.getDialog() );
											ratioButton.on( &#39;mouseover&#39;, function() {
												this.addClass( &#39;cke_btn_over&#39; );
											}, ratioButton );
											ratioButton.on( &#39;mouseout&#39;, function() {
												this.removeClass( &#39;cke_btn_over&#39; );
											}, ratioButton );
										}
									},
									html: &#39;&lt;div&gt;&#39; +
										&#39;&lt;a href=&quot;javascript:void(0)&quot; tabindex=&quot;-1&quot; title=&quot;&#39; + editor.lang.image.lockRatio +
										&#39;&quot; class=&quot;cke_btn_locked&quot; id=&quot;&#39; + btnLockSizesId + &#39;&quot; role=&quot;checkbox&quot;&gt;&lt;span class=&quot;cke_icon&quot;&gt;&lt;/span&gt;&lt;span class=&quot;cke_label&quot;&gt;&#39; + editor.lang.image.lockRatio + &#39;&lt;/span&gt;&lt;/a&gt;&#39; +
										&#39;&lt;a href=&quot;javascript:void(0)&quot; tabindex=&quot;-1&quot; title=&quot;&#39; + editor.lang.image.resetSize +
										&#39;&quot; class=&quot;cke_btn_reset&quot; id=&quot;&#39; + btnResetSizeId + &#39;&quot; role=&quot;button&quot;&gt;&lt;span class=&quot;cke_label&quot;&gt;&#39; + editor.lang.image.resetSize + &#39;&lt;/span&gt;&lt;/a&gt;&#39; +
										&#39;&lt;/div&gt;&#39;
								} ]
							},
							{
								type: &#39;vbox&#39;,
								padding: 1,
								children: [ {
									type: &#39;text&#39;,
									id: &#39;txtBorder&#39;,
									requiredContent: &#39;img{border-width}&#39;,
									width: &#39;60px&#39;,
									label: editor.lang.image.border,
									&#39;default&#39;: &#39;&#39;,
									onKeyUp: function() {
										updatePreview( this.getDialog() );
									},
									onChange: function() {
										commitInternally.call( this, &#39;advanced:txtdlgGenStyle&#39; );
									},
									validate: CKEDITOR.dialog.validate.integer( editor.lang.image.validateBorder ),
									setup: function( type, element ) {
										if ( type == IMAGE ) {
											var value,
												borderStyle = element.getStyle( &#39;border-width&#39; );
											borderStyle = borderStyle &amp;&amp; borderStyle.match( /^(\d+px)(?: \1 \1 \1)?$/ );
											value = borderStyle &amp;&amp; parseInt( borderStyle[ 1 ], 10 );
											isNaN( parseInt( value, 10 ) ) &amp;&amp; ( value = element.getAttribute( &#39;border&#39; ) );
											this.setValue( value );
										}
									},
									commit: function( type, element ) {
										var value = parseInt( this.getValue(), 10 );
										if ( type == IMAGE || type == PREVIEW ) {
											if ( !isNaN( value ) ) {
												element.setStyle( &#39;border-width&#39;, CKEDITOR.tools.cssLength( value ) );
												element.setStyle( &#39;border-style&#39;, &#39;solid&#39; );
											} else if ( !value &amp;&amp; this.isChanged() ) {
												element.removeStyle( &#39;border&#39; );
											}

											if ( type == IMAGE )
												element.removeAttribute( &#39;border&#39; );
										} else if ( type == CLEANUP ) {
											element.removeAttribute( &#39;border&#39; );
											element.removeStyle( &#39;border-width&#39; );
											element.removeStyle( &#39;border-style&#39; );
											element.removeStyle( &#39;border-color&#39; );
										}
									}
								},
								{
									type: &#39;text&#39;,
									id: &#39;txtHSpace&#39;,
									requiredContent: &#39;img{margin-left,margin-right}&#39;,
									width: &#39;60px&#39;,
									label: editor.lang.image.hSpace,
									&#39;default&#39;: &#39;&#39;,
									onKeyUp: function() {
										updatePreview( this.getDialog() );
									},
									onChange: function() {
										commitInternally.call( this, &#39;advanced:txtdlgGenStyle&#39; );
									},
									validate: CKEDITOR.dialog.validate.integer( editor.lang.image.validateHSpace ),
									setup: function( type, element ) {
										if ( type == IMAGE ) {
											var value, marginLeftPx, marginRightPx,
												marginLeftStyle = element.getStyle( &#39;margin-left&#39; ),
												marginRightStyle = element.getStyle( &#39;margin-right&#39; );

											marginLeftStyle = marginLeftStyle &amp;&amp; marginLeftStyle.match( pxLengthRegex );
											marginRightStyle = marginRightStyle &amp;&amp; marginRightStyle.match( pxLengthRegex );
											marginLeftPx = parseInt( marginLeftStyle, 10 );
											marginRightPx = parseInt( marginRightStyle, 10 );

											value = ( marginLeftPx == marginRightPx ) &amp;&amp; marginLeftPx;
											isNaN( parseInt( value, 10 ) ) &amp;&amp; ( value = element.getAttribute( &#39;hspace&#39; ) );

											this.setValue( value );
										}
									},
									commit: function( type, element ) {
										var value = parseInt( this.getValue(), 10 );
										if ( type == IMAGE || type == PREVIEW ) {
											if ( !isNaN( value ) ) {
												element.setStyle( &#39;margin-left&#39;, CKEDITOR.tools.cssLength( value ) );
												element.setStyle( &#39;margin-right&#39;, CKEDITOR.tools.cssLength( value ) );
											} else if ( !value &amp;&amp; this.isChanged() ) {
												element.removeStyle( &#39;margin-left&#39; );
												element.removeStyle( &#39;margin-right&#39; );
											}

											if ( type == IMAGE )
												element.removeAttribute( &#39;hspace&#39; );
										} else if ( type == CLEANUP ) {
											element.removeAttribute( &#39;hspace&#39; );
											element.removeStyle( &#39;margin-left&#39; );
											element.removeStyle( &#39;margin-right&#39; );
										}
									}
								},
								{
									type: &#39;text&#39;,
									id: &#39;txtVSpace&#39;,
									requiredContent: &#39;img{margin-top,margin-bottom}&#39;,
									width: &#39;60px&#39;,
									label: editor.lang.image.vSpace,
									&#39;default&#39;: &#39;&#39;,
									onKeyUp: function() {
										updatePreview( this.getDialog() );
									},
									onChange: function() {
										commitInternally.call( this, &#39;advanced:txtdlgGenStyle&#39; );
									},
									validate: CKEDITOR.dialog.validate.integer( editor.lang.image.validateVSpace ),
									setup: function( type, element ) {
										if ( type == IMAGE ) {
											var value, marginTopPx, marginBottomPx,
												marginTopStyle = element.getStyle( &#39;margin-top&#39; ),
												marginBottomStyle = element.getStyle( &#39;margin-bottom&#39; );

											marginTopStyle = marginTopStyle &amp;&amp; marginTopStyle.match( pxLengthRegex );
											marginBottomStyle = marginBottomStyle &amp;&amp; marginBottomStyle.match( pxLengthRegex );
											marginTopPx = parseInt( marginTopStyle, 10 );
											marginBottomPx = parseInt( marginBottomStyle, 10 );

											value = ( marginTopPx == marginBottomPx ) &amp;&amp; marginTopPx;
											isNaN( parseInt( value, 10 ) ) &amp;&amp; ( value = element.getAttribute( &#39;vspace&#39; ) );
											this.setValue( value );
										}
									},
									commit: function( type, element ) {
										var value = parseInt( this.getValue(), 10 );
										if ( type == IMAGE || type == PREVIEW ) {
											if ( !isNaN( value ) ) {
												element.setStyle( &#39;margin-top&#39;, CKEDITOR.tools.cssLength( value ) );
												element.setStyle( &#39;margin-bottom&#39;, CKEDITOR.tools.cssLength( value ) );
											} else if ( !value &amp;&amp; this.isChanged() ) {
												element.removeStyle( &#39;margin-top&#39; );
												element.removeStyle( &#39;margin-bottom&#39; );
											}

											if ( type == IMAGE )
												element.removeAttribute( &#39;vspace&#39; );
										} else if ( type == CLEANUP ) {
											element.removeAttribute( &#39;vspace&#39; );
											element.removeStyle( &#39;margin-top&#39; );
											element.removeStyle( &#39;margin-bottom&#39; );
										}
									}
								},
								{
									id: &#39;cmbAlign&#39;,
									requiredContent: &#39;img{float}&#39;,
									type: &#39;select&#39;,
									widths: [ &#39;35%&#39;, &#39;65%&#39; ],
									style: &#39;width:90px&#39;,
									label: editor.lang.common.align,
									&#39;default&#39;: &#39;&#39;,
									items: [
										[ editor.lang.common.notSet, &#39;&#39; ],
										[ editor.lang.common.alignLeft, &#39;left&#39; ],
										[ editor.lang.common.alignRight, &#39;right&#39; ]
										// Backward compatible with v2 on setup when specified as attribute value,
										// while these values are no more available as select options.
										//	[ editor.lang.image.alignAbsBottom , &#39;absBottom&#39;],
										//	[ editor.lang.image.alignAbsMiddle , &#39;absMiddle&#39;],
										//  [ editor.lang.image.alignBaseline , &#39;baseline&#39;],
										//  [ editor.lang.image.alignTextTop , &#39;text-top&#39;],
										//  [ editor.lang.image.alignBottom , &#39;bottom&#39;],
										//  [ editor.lang.image.alignMiddle , &#39;middle&#39;],
										//  [ editor.lang.image.alignTop , &#39;top&#39;]
									],
									onChange: function() {
										updatePreview( this.getDialog() );
										commitInternally.call( this, &#39;advanced:txtdlgGenStyle&#39; );
									},
									setup: function( type, element ) {
										if ( type == IMAGE ) {
											var value = element.getStyle( &#39;float&#39; );
											switch ( value ) {
												// Ignore those unrelated values.
												case &#39;inherit&#39;:
												case &#39;none&#39;:
													value = &#39;&#39;;
											}

											!value &amp;&amp; ( value = ( element.getAttribute( &#39;align&#39; ) || &#39;&#39; ).toLowerCase() );
											this.setValue( value );
										}
									},
									commit: function( type, element ) {
										var value = this.getValue();
										if ( type == IMAGE || type == PREVIEW ) {
											if ( value )
												element.setStyle( &#39;float&#39;, value );
											else
												element.removeStyle( &#39;float&#39; );

											if ( type == IMAGE ) {
												value = ( element.getAttribute( &#39;align&#39; ) || &#39;&#39; ).toLowerCase();
												switch ( value ) {
													// we should remove it only if it matches &quot;left&quot; or &quot;right&quot;,
													// otherwise leave it intact.
													case &#39;left&#39;:
													case &#39;right&#39;:
														element.removeAttribute( &#39;align&#39; );
												}
											}
										} else if ( type == CLEANUP ) {
											element.removeStyle( &#39;float&#39; );
										}
									}
								} ]
							} ]
						},
						{
							type: &#39;vbox&#39;,
							height: &#39;250px&#39;,
							children: [ {
								type: &#39;html&#39;,
								id: &#39;htmlPreview&#39;,
								style: &#39;width:95%;&#39;,
								html: &#39;&lt;div&gt;&#39; + CKEDITOR.tools.htmlEncode( editor.lang.common.preview ) + &#39;&lt;br&gt;&#39; +
									&#39;&lt;div id=&quot;&#39; + imagePreviewLoaderId + &#39;&quot; class=&quot;ImagePreviewLoader&quot; style=&quot;display:none&quot;&gt;&lt;div class=&quot;loading&quot;&gt;&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&#39; +
									&#39;&lt;div class=&quot;ImagePreviewBox&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;&#39; +
										&#39;&lt;a href=&quot;javascript:void(0)&quot; target=&quot;_blank&quot; onclick=&quot;return false;&quot; id=&quot;&#39; + previewLinkId + &#39;&quot;&gt;&#39; +
										&#39;&lt;img id=&quot;&#39; + previewImageId + &#39;&quot; alt=&quot;&quot; /&gt;&lt;/a&gt;&#39; +
									// jscs:disable maximumLineLength
										( editor.config.image_previewText || &#39;Lorem ipsum dolor sit amet, consectetuer adipiscing elit. &#39; +
											&#39;Maecenas feugiat consequat diam. Maecenas metus. Vivamus diam purus, cursus a, commodo non, facilisis vitae, &#39; +
											&#39;nulla. Aenean dictum lacinia tortor. Nunc iaculis, nibh non iaculis aliquam, orci felis euismod neque, sed ornare massa mauris sed velit. Nulla pretium mi et risus. Fusce mi pede, tempor id, cursus ac, ullamcorper nec, enim. Sed tortor. Curabitur molestie. Duis velit augue, condimentum at, ultrices a, luctus ut, orci. Donec pellentesque egestas eros. Integer cursus, augue in cursus faucibus, eros pede bibendum sem, in tempus tellus justo quis ligula. Etiam eget tortor. Vestibulum rutrum, est ut placerat elementum, lectus nisl aliquam velit, tempor aliquam eros nunc nonummy metus. In eros metus, gravida a, gravida sed, lobortis id, turpis. Ut ultrices, ipsum at venenatis fringilla, sem nulla lacinia tellus, eget aliquet turpis mauris non enim. Nam turpis. Suspendisse lacinia. Curabitur ac tortor ut ipsum egestas elementum. Nunc imperdiet gravida mauris.&#39; ) +
									// jscs:enable maximumLineLength
									&#39;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/div&gt;&#39;
							} ]
						} ]
					} ]
				},
				{
					id: &#39;Link&#39;,
					requiredContent: &#39;a[href]&#39;,
					label: editor.lang.image.linkTab,
					padding: 0,
					elements: [ {
						id: &#39;txtUrl&#39;,
						type: &#39;text&#39;,
						label: editor.lang.common.url,
						style: &#39;width: 100%&#39;,
						&#39;default&#39;: &#39;&#39;,
						setup: function( type, element ) {
							if ( type == LINK ) {
								var href = element.data( &#39;cke-saved-href&#39; );
								if ( !href )
									href = element.getAttribute( &#39;href&#39; );
								this.setValue( href );
							}
						},
						commit: function( type, element ) {
							if ( type == LINK ) {
								if ( this.getValue() || this.isChanged() ) {
									var url = this.getValue();
									element.data( &#39;cke-saved-href&#39;, url );
									element.setAttribute( &#39;href&#39;, url );

									if ( this.getValue() || !editor.config.image_removeLinkByEmptyURL )
										this.getDialog().addLink = true;
									else
										this.getDialog().addLink = false;
								}
							}
						}
					},
					{
						type: &#39;button&#39;,
						id: &#39;browse&#39;,
						filebrowser: {
							action: &#39;Browse&#39;,
							target: &#39;Link:txtUrl&#39;,
							url: editor.config.filebrowserImageBrowseLinkUrl
						},
						style: &#39;float:right&#39;,
						hidden: true,
						label: editor.lang.common.browseServer
					},
					{
						id: &#39;cmbTarget&#39;,
						type: &#39;select&#39;,
						requiredContent: &#39;a[target]&#39;,
						label: editor.lang.common.target,
						&#39;default&#39;: &#39;&#39;,
						items: [
							[ editor.lang.common.notSet, &#39;&#39; ],
							[ editor.lang.common.targetNew, &#39;_blank&#39; ],
							[ editor.lang.common.targetTop, &#39;_top&#39; ],
							[ editor.lang.common.targetSelf, &#39;_self&#39; ],
							[ editor.lang.common.targetParent, &#39;_parent&#39; ]
						],
						setup: function( type, element ) {
							if ( type == LINK )
								this.setValue( element.getAttribute( &#39;target&#39; ) || &#39;&#39; );
						},
						commit: function( type, element ) {
							if ( type == LINK ) {
								if ( this.getValue() || this.isChanged() )
									element.setAttribute( &#39;target&#39;, this.getValue() );
							}
						}
					} ]
				},
				{
					id: &#39;Upload&#39;,
					hidden: true,
					filebrowser: &#39;uploadButton&#39;,
					label: editor.lang.image.upload,
					elements: [ {
						type: &#39;file&#39;,
						id: &#39;upload&#39;,
						label: editor.lang.image.btnUpload,
						style: &#39;height:40px&#39;,
						size: 38
					},
					{
						type: &#39;fileButton&#39;,
						id: &#39;uploadButton&#39;,
						filebrowser: &#39;info:txtUrl&#39;,
						label: editor.lang.image.btnUpload,
						&#39;for&#39;: [ &#39;Upload&#39;, &#39;upload&#39; ]
					} ]
				},
				{
					id: &#39;advanced&#39;,
					label: editor.lang.common.advancedTab,
					elements: [ {
						type: &#39;hbox&#39;,
						widths: [ &#39;50%&#39;, &#39;25%&#39;, &#39;25%&#39; ],
						children: [ {
							type: &#39;text&#39;,
							id: &#39;linkId&#39;,
							requiredContent: &#39;img[id]&#39;,
							label: editor.lang.common.id,
							setup: function( type, element ) {
								if ( type == IMAGE )
									this.setValue( element.getAttribute( &#39;id&#39; ) );
							},
							commit: function( type, element ) {
								if ( type == IMAGE ) {
									if ( this.getValue() || this.isChanged() )
										element.setAttribute( &#39;id&#39;, this.getValue() );
								}
							}
						},
						{
							id: &#39;cmbLangDir&#39;,
							type: &#39;select&#39;,
							requiredContent: &#39;img[dir]&#39;,
							style: &#39;width : 100px;&#39;,
							label: editor.lang.common.langDir,
							&#39;default&#39;: &#39;&#39;,
							items: [
								[ editor.lang.common.notSet, &#39;&#39; ],
								[ editor.lang.common.langDirLtr, &#39;ltr&#39; ],
								[ editor.lang.common.langDirRtl, &#39;rtl&#39; ]
							],
							setup: function( type, element ) {
								if ( type == IMAGE )
									this.setValue( element.getAttribute( &#39;dir&#39; ) );
							},
							commit: function( type, element ) {
								if ( type == IMAGE ) {
									if ( this.getValue() || this.isChanged() )
										element.setAttribute( &#39;dir&#39;, this.getValue() );
								}
							}
						},
						{
							type: &#39;text&#39;,
							id: &#39;txtLangCode&#39;,
							requiredContent: &#39;img[lang]&#39;,
							label: editor.lang.common.langCode,
							&#39;default&#39;: &#39;&#39;,
							setup: function( type, element ) {
								if ( type == IMAGE )
									this.setValue( element.getAttribute( &#39;lang&#39; ) );
							},
							commit: function( type, element ) {
								if ( type == IMAGE ) {
									if ( this.getValue() || this.isChanged() )
										element.setAttribute( &#39;lang&#39;, this.getValue() );
								}
							}
						} ]
					},
					{
						type: &#39;text&#39;,
						id: &#39;txtGenLongDescr&#39;,
						requiredContent: &#39;img[longdesc]&#39;,
						label: editor.lang.common.longDescr,
						setup: function( type, element ) {
							if ( type == IMAGE )
								this.setValue( element.getAttribute( &#39;longDesc&#39; ) );
						},
						commit: function( type, element ) {
							if ( type == IMAGE ) {
								if ( this.getValue() || this.isChanged() )
									element.setAttribute( &#39;longDesc&#39;, this.getValue() );
							}
						}
					},
					{
						type: &#39;hbox&#39;,
						widths: [ &#39;50%&#39;, &#39;50%&#39; ],
						children: [ {
							type: &#39;text&#39;,
							id: &#39;txtGenClass&#39;,
							requiredContent: &#39;img(cke-xyz)&#39;, // Random text like &#39;xyz&#39; will check if all are allowed.
							label: editor.lang.common.cssClass,
							&#39;default&#39;: &#39;&#39;,
							setup: function( type, element ) {
								if ( type == IMAGE )
									this.setValue( element.getAttribute( &#39;class&#39; ) );
							},
							commit: function( type, element ) {
								if ( type == IMAGE ) {
									if ( this.getValue() || this.isChanged() )
										element.setAttribute( &#39;class&#39;, this.getValue() );
								}
							}
						},
						{
							type: &#39;text&#39;,
							id: &#39;txtGenTitle&#39;,
							requiredContent: &#39;img[title]&#39;,
							label: editor.lang.common.advisoryTitle,
							&#39;default&#39;: &#39;&#39;,
							onChange: function() {
								updatePreview( this.getDialog() );
							},
							setup: function( type, element ) {
								if ( type == IMAGE )
									this.setValue( element.getAttribute( &#39;title&#39; ) );
							},
							commit: function( type, element ) {
								if ( type == IMAGE ) {
									if ( this.getValue() || this.isChanged() )
										element.setAttribute( &#39;title&#39;, this.getValue() );
								} else if ( type == PREVIEW )
									element.setAttribute( &#39;title&#39;, this.getValue() );
								else if ( type == CLEANUP ) {
									element.removeAttribute( &#39;title&#39; );
								}
							}
						} ]
					},
					{
						type: &#39;text&#39;,
						id: &#39;txtdlgGenStyle&#39;,
						requiredContent: &#39;img{cke-xyz}&#39;, // Random text like &#39;xyz&#39; will check if all are allowed.
						label: editor.lang.common.cssStyle,
						validate: CKEDITOR.dialog.validate.inlineStyle( editor.lang.common.invalidInlineStyle ),
						&#39;default&#39;: &#39;&#39;,
						setup: function( type, element ) {
							if ( type == IMAGE ) {
								var genStyle = element.getAttribute( &#39;style&#39; );
								if ( !genStyle &amp;&amp; element.$.style.cssText )
									genStyle = element.$.style.cssText;
								this.setValue( genStyle );

								var height = element.$.style.height,
									width = element.$.style.width,
									aMatchH = ( height ? height : &#39;&#39; ).match( regexGetSize ),
									aMatchW = ( width ? width : &#39;&#39; ).match( regexGetSize );

								this.attributesInStyle = {
									height: !!aMatchH,
									width: !!aMatchW
								};
							}
						},
						onChange: function() {
							commitInternally.call(
								this, [
									&#39;info:cmbFloat&#39;,
									&#39;info:cmbAlign&#39;,
									&#39;info:txtVSpace&#39;,
									&#39;info:txtHSpace&#39;,
									&#39;info:txtBorder&#39;,
									&#39;info:txtWidth&#39;,
									&#39;info:txtHeight&#39;
								]
							);
							updatePreview( this );
						},
						commit: function( type, element ) {
							if ( type == IMAGE &amp;&amp; ( this.getValue() || this.isChanged() ) )
								element.setAttribute( &#39;style&#39;, this.getValue() );

						}
					} ]
				} ]
			};
		};

	CKEDITOR.dialog.add( &#39;image&#39;, function( editor ) {
		return imageDialog( editor, &#39;image&#39; );
	} );

	CKEDITOR.dialog.add( &#39;imagebutton&#39;, function( editor ) {
		return imageDialog( editor, &#39;imagebutton&#39; );
	} );
} )();
</pre>
</body>
</html>
